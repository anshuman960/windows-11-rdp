name: Windows 11 RDP

on:
  workflow_dispatch:
    inputs:
      rdp_password:
        description: 'Custom RDP Password (optional)'
        required: false
        default: 'P@ssw0rd123!'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
  RDP_USER: runneradmin
  RDP_PASS: ${{ inputs.rdp_password }}

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Ngrok
      run: |
        Write-Host "Downloading ngrok..."
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Write-Host "Download completed"
      shell: powershell

    - name: Extract Ngrok
      run: |
        Write-Host "Extracting ngrok..."
        Expand-Archive ngrok.zip -DestinationPath ngrok
        Write-Host "Extraction completed"
      shell: powershell

    - name: Authenticate Ngrok
      run: |
        Write-Host "Authenticating ngrok..."
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
        Write-Host "Authentication completed"
      shell: powershell
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Enable Remote Desktop
      run: |
        Write-Host "Enabling Remote Desktop..."
        # Enable Terminal Services
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        
        # Enable Remote Desktop through Windows Firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Enable Network Level Authentication
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        # Set RDP password for runneradmin user
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "$env:RDP_PASS" -Force)
        
        Write-Host "Remote Desktop enabled successfully"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
      shell: powershell

    - name: Create RDP Information File
      run: |
        $rdpInfo = @"
        Windows 11 RDP Connection Details
        =================================
        
        Username: $env:RDP_USER
        Password: $env:RDP_PASS
        
        System Information:
        - OS: Windows Server 2022 (GitHub Actions Runner)
        - RAM: 7 GB
        - CPU: 2 cores
        - Storage: 14 GB SSD
        - Network: High-speed internet
        
        Instructions:
        1. Wait for ngrok tunnel to be established
        2. Use the provided IP and port to connect
        3. Use Windows Remote Desktop Connection or any RDP client
        4. Session will remain active for up to 6 hours
        
        Generated at: $(Get-Date)
        "@
        
        $rdpInfo | Out-File -FilePath "rdp_info.txt" -Encoding UTF8
        Write-Host $rdpInfo
      shell: powershell

    - name: Display System Information
      run: |
        Write-Host "=== System Information ==="
        Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory, CsProcessors | Format-List
        
        Write-Host "=== Network Configuration ==="
        Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notmatch "Loopback"} | Format-Table
        
        Write-Host "=== Available Software ==="
        Write-Host "- Google Chrome"
        Write-Host "- Microsoft Edge"
        Write-Host "- Visual Studio Code"
        Write-Host "- Git"
        Write-Host "- Node.js"
        Write-Host "- Python"
        Write-Host "- PowerShell 7"
        Write-Host "- Windows Terminal"
      shell: powershell

    - name: Start Ngrok Tunnel
      run: |
        Write-Host "Starting ngrok tunnel on port 3389..."
        Write-Host "Please wait for tunnel URL to be displayed..."
        
        # Start ngrok in background and capture output
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp", "3389", "--log", "stdout" -NoNewWindow -RedirectStandardOutput "ngrok_output.txt"
        
        # Wait for ngrok to start and get tunnel info
        Start-Sleep -Seconds 10
        
        # Try to get tunnel info from ngrok API
        try {
            $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get
            $tunnel = $response.tunnels[0]
            $publicUrl = $tunnel.public_url
            
            Write-Host "==========================================="
            Write-Host "ðŸš€ RDP CONNECTION ESTABLISHED!"
            Write-Host "==========================================="
            Write-Host "Tunnel URL: $publicUrl"
            Write-Host "Username: $env:RDP_USER"
            Write-Host "Password: $env:RDP_PASS"
            Write-Host "==========================================="
            Write-Host ""
            Write-Host "How to connect:"
            Write-Host "1. Open Remote Desktop Connection on your computer"
            Write-Host "2. Enter the tunnel URL (without tcp://)"
            Write-Host "3. Use the credentials above"
            Write-Host "4. Click Connect"
            Write-Host ""
            Write-Host "Session will remain active for up to 6 hours."
            Write-Host "==========================================="
        } catch {
            Write-Host "Ngrok API not ready yet, checking output file..."
            if (Test-Path "ngrok_output.txt") {
                Get-Content "ngrok_output.txt"
            }
        }
      shell: powershell

    - name: Keep Session Alive
      run: |
        Write-Host "Keeping RDP session alive..."
        Write-Host "This workflow will run for up to 6 hours."
        Write-Host "You can cancel the workflow to stop the RDP session."
        Write-Host ""
        Write-Host "Current time: $(Get-Date)"
        Write-Host "Session will automatically end at: $((Get-Date).AddHours(6))"
        
        # Keep the session alive by running a loop
        $endTime = (Get-Date).AddHours(6)
        while ((Get-Date) -lt $endTime) {
            Write-Host "Session active - $(Get-Date) - Time remaining: $(($endTime - (Get-Date)).ToString('hh\:mm\:ss'))"
            Start-Sleep -Seconds 300  # Check every 5 minutes
            
            # Optional: Check if ngrok is still running
            $ngrokProcess = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
            if (-not $ngrokProcess) {
                Write-Host "Ngrok process stopped. Restarting..."
                Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp", "3389" -NoNewWindow
                Start-Sleep -Seconds 5
            }
        }
        
        Write-Host "Session timeout reached. Ending RDP session."
      shell: powershell